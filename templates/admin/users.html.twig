{% extends 'back/base.html.twig' %}
{% set panel = 'admin' %}

{% block title %}Admin | Users{% endblock %}

{% block content %}
  <section class="panel" style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
    <h1 style="margin:0">User Management</h1>
    <div>
      <a href="{{ path('admin_users') }}" class="action {{ roleFilter == '' ? 'gold' : '' }}">All</a>
      <a href="{{ path('admin_users', {'role': 'teacher'}) }}" class="action {{ roleFilter == 'teacher' ? 'gold' : '' }}">Teachers</a>
      <a href="{{ path('admin_users', {'role': 'student'}) }}" class="action {{ roleFilter == 'student' ? 'gold' : '' }}">Students</a>
      <a href="#user-modal" class="action gold">Add User</a>
    </div>
  </section>

  <section class="panel" style="margin-top:12px">
    <input id="user-search" type="text" placeholder="Search users by name/email..." style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(197,218,255,.25);background:#0d2444;color:#fff">
  </section>

  {% if roleFilter == 'student' %}
    <section class="panel" style="margin-top:12px">
      <h3 style="margin-top:0">Students by Grade and Group</h3>
      {% if studentsByGradeAndGroup is empty %}
        <p style="margin:0;color:#bdd0ed">No students found.</p>
      {% else %}
        {% for grade, groups in studentsByGradeAndGroup %}
          <article class="panel" style="margin-bottom:10px">
            <h4 style="margin:0 0 10px;color:#ffd86b">Grade: {{ grade }}</h4>
            {% for group, students in groups %}
              <div style="margin-bottom:10px">
                <strong>{{ group }}</strong>
                <table style="width:100%;border-collapse:collapse;margin-top:6px">
                  <thead>
                    <tr>
                      <th style="text-align:left;padding:6px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Name</th>
                      <th style="text-align:left;padding:6px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Email</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in students %}
                      <tr class="user-row" data-search="{{ row.name|lower }} {{ row.email|lower }}">
                        <td style="padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.name }}</td>
                        <td style="padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.email }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endfor %}
          </article>
        {% endfor %}
      {% endif %}
    </section>
  {% else %}
    <section class="panel" style="margin-top:12px">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Avatar</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Name</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Email</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Password</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Role</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Grade</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Group</th>
            <th style="text-align:left;padding:8px 4px;border-bottom:1px solid rgba(197,218,255,.25)">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in userRows %}
            <tr class="user-row" data-search="{{ row.name|lower }} {{ row.email|lower }} {{ row.role|lower }}">
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">@</td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.name }}</td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.email }}</td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.password }}</td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)"><span style="background:#133764;padding:4px 8px;border-radius:999px">{{ row.role|title }}</span></td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.grade ?: '-' }}</td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">{{ row.group ?: '-' }}</td>
              <td style="padding:10px 4px;border-bottom:1px solid rgba(197,218,255,.15)">
                <select style="background:#11325e;color:#fff;border:1px solid rgba(255,255,255,.2);padding:6px;border-radius:8px">
                  <option>Edit</option>
                  <option>Delete</option>
                </select>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="8" style="padding:10px 4px;color:#bdd0ed">No users found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% endif %}

  <section id="user-modal" class="panel" style="margin-top:12px">
    <h3 style="margin-top:0">Add / Edit User</h3>
    <form method="post">
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <input name="name" type="text" placeholder="Name" required style="padding:10px;border-radius:10px;border:1px solid rgba(197,218,255,.25);background:#0d2444;color:#fff">
        <input name="email" type="email" placeholder="Email" required style="padding:10px;border-radius:10px;border:1px solid rgba(197,218,255,.25);background:#0d2444;color:#fff">
        <input name="password" type="password" placeholder="Password" required style="padding:10px;border-radius:10px;border:1px solid rgba(197,218,255,.25);background:#0d2444;color:#fff">
        <select id="role-select" name="role" style="padding:10px;border-radius:10px;border:1px solid rgba(197,218,255,.25);background:#0d2444;color:#fff">
          <option value="admin">Admin</option>
          <option value="teacher">Teacher</option>
          <option value="student">Student</option>
        </select>
        <div id="grade-wrap" style="display:none">
          <input id="grade-input" name="grade" type="text" placeholder="Student grade (optional)" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(197,218,255,.25);background:#0d2444;color:#fff">
        </div>
      </div>
      <p style="margin:12px 0 0"><button type="submit" class="action gold" style="cursor:pointer;border:none">Save</button> <button type="button" class="action" style="cursor:pointer">Cancel</button></p>
    </form>
  </section>
{% endblock %}

{% block javascripts %}
  <script>
    (function () {
      const roleSelect = document.getElementById('role-select');
      const gradeWrap = document.getElementById('grade-wrap');
      const gradeInput = document.getElementById('grade-input');
      const searchInput = document.getElementById('user-search');
      const rows = Array.from(document.querySelectorAll('.user-row'));

      function toggleGrade() {
        if (!roleSelect || !gradeWrap) {
          return;
        }
        const isStudent = roleSelect.value === 'student';
        gradeWrap.style.display = isStudent ? 'block' : 'none';
        if (gradeInput) {
          gradeInput.disabled = !isStudent;
        }
      }

      function filterRows() {
        if (!searchInput) {
          return;
        }
        const query = searchInput.value.trim().toLowerCase();
        rows.forEach((row) => {
          const haystack = row.getAttribute('data-search') || '';
          row.style.display = haystack.includes(query) ? '' : 'none';
        });
      }

      if (roleSelect) {
        roleSelect.addEventListener('change', toggleGrade);
        toggleGrade();
      }
      if (searchInput) {
        searchInput.addEventListener('input', filterRows);
      }
    })();
  </script>
{% endblock %}
